FROM nvidia/cuda:12.8.1-cudnn-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-lc"]

# ----------------------------
# System dependencies
# ----------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential cmake git wget curl unzip pkg-config \
    python3.11 python3.11-dev python3-pip \
    libgl1 libsm6 libxrender1 libxext6 libglu1-mesa \
    libjpeg-dev libpng-dev zlib1g-dev libtbb-dev libx11-dev \
    libssl-dev libffi-dev libeigen3-dev libopenblas-dev \
    liblapack-dev libatlas-base-dev libgomp1 \
    libegl1-mesa libxrandr-dev libxcursor-dev libxinerama-dev \
    mesa-common-dev mesa-utils \
    && rm -rf /var/lib/apt/lists/*

# Symlink python
RUN ln -s /usr/bin/python3.11 /usr/bin/python || true

# Upgrade pip
RUN python -m pip install --upgrade pip setuptools wheel

# ----------------------------
# Install PyTorch (CUDA 12.8) and torch-scatter
# ----------------------------
# Copy wheels from local directory
COPY ./wheels /opt/wheels

# Install from local wheels (prioritizing them with --find-links)
RUN pip install torch==2.7.1 --find-links /opt/wheels --no-index
RUN pip install torch-scatter --find-links /opt/wheels --no-index

# ----------------------------
# Clone PartUV repository
# ----------------------------
WORKDIR /opt
# RUN git clone https://github.com/EricWang12/PartUV.git partuv
COPY ./PartUV /opt/partuv
WORKDIR /opt/partuv

# ----------------------------
# Install project requirements via pip
# ----------------------------
RUN pip install -r requirements.txt

# Install PartUV itself
RUN pip install partuv

# ----------------------------
# Build native C++ components (se presente build.sh)
# ----------------------------
RUN chmod +x build.sh && bash build.sh || true

# ----------------------------
# Set working directory and default shell
# ----------------------------
WORKDIR /opt/partuv